<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ext4: Mysterious “No space left on device”-errors | Mero's Blog</title><meta name=keywords content="linux"><meta name=description content="ext4 has a feature called dir_index enabled by default, which is quite susceptible to hash-collisions"><meta name=author content><link rel=canonical href=https://blog.merovius.de/posts/2013-10-20-ext4-mysterious-no-space-left-on/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.merovius.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.merovius.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.merovius.de/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.merovius.de/apple-touch-icon.png><link rel=mask-icon href=https://blog.merovius.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="ext4: Mysterious “No space left on device”-errors"><meta property="og:description" content="ext4 has a feature called dir_index enabled by default, which is quite susceptible to hash-collisions"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.merovius.de/posts/2013-10-20-ext4-mysterious-no-space-left-on/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-10-20T21:13:07+00:00"><meta property="article:modified_time" content="2013-10-20T21:13:07+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ext4: Mysterious “No space left on device”-errors"><meta name=twitter:description content="ext4 has a feature called dir_index enabled by default, which is quite susceptible to hash-collisions"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.merovius.de/posts/"},{"@type":"ListItem","position":2,"name":"ext4: Mysterious “No space left on device”-errors","item":"https://blog.merovius.de/posts/2013-10-20-ext4-mysterious-no-space-left-on/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ext4: Mysterious “No space left on device”-errors","name":"ext4: Mysterious “No space left on device”-errors","description":"ext4 has a feature called dir_index enabled by default, which is quite susceptible to hash-collisions","keywords":["linux"],"articleBody":"tl;dr: ext4 has a feature called dir_index enabled by default, which is quite susceptible to hash-collisions\nI am currently restructuring my mail-setup. Currently, I use offlineimap to sync my separate accounts to a series of maildirs on my server. I then use sup on the server as a MUA. I want to switch to a local setup with notmuch, so I set up an dovecot imapd on my server and have all my accounts forward to my primary address. I then want to use offlineimap to have my mails in a local maildir, which I browse with notmuch.\nI then stumbled about a curious problem: When trying to copy my mails from my server to my local harddisk, it would fail after about 50K E-mails with the message “could not create xyz: no space left on device” (actually, offlineimap would just hog all my CPUs and freeze my whole machine in the process, but that’s a different story). But there actually was plenty of space left.\nIt took me and a few friends a whole while to discover the problem. So if you ever get this error message (using ext4) you should probably check these four things (my issue was the last one):\nDo you actually have enough space? Use df -h. There is actually a very common pitfall with ext4. Let’s have a look:\nmero@rincewind ~$ df -h Filesystem Size Used Avail Use% Mounted on /dev/mapper/sda2_crypt 235G 164G 69G 71% / ... If you add 164G and 69G, you get 233G, which is 2G short of the actual size. This is about 1%, but on your system it will likely be more of 5% difference. The reason is the distinction between “free” and “available” space. Per default on ext4, there are about 5% of “reserved” blocks. This has two reasons: First ext4’s performance seems to take a small hit, when almost full. Secondly, it leaves a little space for root to login and troubleshoot problems or delete some files, when users filled their home-directory. If there was no space left, it might well be, that no login is possible anymore (because of the creation of temporary files, logfiles, history-files…). So use tune2fs  to see, if you have reserved blocks, and how many of them:\nmero@rincewind ~$ sudo tune2fs -l /dev/mapper/sda2_crypt | grep \"Reserved block\" Reserved block count: 2499541 Reserved blocks uid: 0 (user root) Reserved blocks gid: 0 (group root) Do you have too many files? Even though you might have enough space left, it might well be, that you have too many files. ext4 allows an enormous amount of files on any file system, but it is limited. Checking this is easy: Just use df -i:\nFilesystem Inodes IUsed IFree IUse% Mounted on /dev/mapper/sda2_crypt 15622144 925993 14696151 6% / ... So as you see, that wasn’t the problem with me. But if you ever have the IUse% column near 100, you probably want to delete some old files (and you should definitely question, how so many files could be created to begin with).\nDo a file system check At least some people on the internet say, that something like this has happened to them after a crash (coincidentally my system crashed before the problem arose. See above comments about offlineimap) and that a file system check got rid of it. So you probably want to run fsck -f  to run such a check. You probably also want to do that from a live-system, if you cannot unmount it (for example if it’s mounted at the root-dir).\nDo you have dir_index enabled? So this is the punch line: ext4 has the possibility to hash the filenames of its contents. This enhances performance, but has a “small” problem: ext4 does not grow its hashtable, when it starts to fill up. Instead it returns -ENOSPC or “no space left on device”.\next4 uses half_md4 as a default hashing-mechanism. If I interpret my google-results correctly, this uses the md4-hash algorithm, but strips it to 32 bits. This is a classical example of the birthday-paradox: A 32 bit hash means, that there are 4294967296 different hash values available, so if we are fair and assume a uniform distribution of hash values, that makes it highly unlikely to hit one specific hash. But the probability of hitting two identical hashes, given enough filenames, is much much higher. Using the formula from Wikipedia we get (with about 50K files) a probability of about 25% that a newly added file has the same hash. This is a huge probability of failure. If on the other hand we take a 64bit hash-function the probability becomes much smaller, about 0.00000000007%.\nSo if you have a lot of files in the same directory, you probably want to switch off dir_index, or at least change to a different hash-algorithm. You can check if you have dir_index enabled and change the hash, like this:\nmero@rincewind ~$ sudo tune2fs -l /dev/mapper/sda2_crypt | grep -o dir_index dir_index ## Change the hash-algo to a bigger one mero@rincewind ~$ sudo tune2fs -E \"hash_alg=tea\" /dev/mapper/sda2_crypt ## Disable it completely mero@rincewind ~$ sudo tune2fs -O \"^dir_index\" Note however, that dir_index and half_md4 where choices made for performance reasons. So you might experience a performance-hit after this.\nUPDATE: After trying it out, I realized, that the problem actually also persists with the tea-hash. I then had a look at the ext4-documentation about the topic and it seems, that the hash is only stored as 32 bits, so it actually does not matter what hash we choose, regarding this particular problem. So if half_md4 is chosen because of its better performance and collision-resistance it actually makes sense to leave it as the default. You can by the way easily test and reproduce the issue by using the following on an ext4 file system:\nfor a in `seq 100000` do file=`head -c 51 /dev/urandom | base64 | tr '/' '_'` touch $file done Curiously, this only gives me about 160 collisions on 100K files (instead of about 10K collisions on 60K files), which would suggest, that my original sample (meaning my mailbox) exhibits some properties that make collisions more likely both on half_md4 and tea.\n","wordCount":"1027","inLanguage":"en","datePublished":"2013-10-20T21:13:07Z","dateModified":"2013-10-20T21:13:07Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.merovius.de/posts/2013-10-20-ext4-mysterious-no-space-left-on/"},"publisher":{"@type":"Organization","name":"Mero's Blog","logo":{"@type":"ImageObject","url":"https://blog.merovius.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.merovius.de/ accesskey=h title="Mero's Blog (Alt + H)">Mero's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ext4: Mysterious “No space left on device”-errors</h1><div class=post-meta><span title="2013-10-20 21:13:07 +0000 UTC">October 20, 2013</span></div></header><div class=post-content><p><strong>tl;dr: ext4 has a feature called <code>dir_index</code> enabled by default, which is
quite susceptible to hash-collisions</strong></p><p>I am currently restructuring my mail-setup. Currently, I use offlineimap to
sync my separate accounts to a series of maildirs on my server. I then use sup
on the server as a MUA. I want to switch to a local setup with notmuch, so I
set up an dovecot imapd on my server and have all my accounts forward to my
primary address. I then want to use offlineimap to have my mails in a local
maildir, which I browse with notmuch.</p><p>I then stumbled about a curious problem: When trying to copy my mails from my
server to my local harddisk, it would fail after about 50K E-mails with the
message “could not create xyz: no space left on device” (actually, offlineimap
would just hog all my CPUs and freeze my whole machine in the process, but
that&rsquo;s a different story). But there actually was plenty of space left.</p><p>It took me and a few friends a whole while to discover the problem. So if you
ever get this error message (using ext4) you should probably check these four
things (my issue was the last one):</p><h2 id=do-you-actually-have-enough-space>Do you <em>actually</em> have enough space?<a hidden class=anchor aria-hidden=true href=#do-you-actually-have-enough-space>#</a></h2><p>Use <code>df -h</code>. There is actually a very common pitfall with ext4. Let&rsquo;s have a look:</p><pre tabindex=0><code>mero@rincewind ~$ df -h
Filesystem              Size  Used Avail Use% Mounted on
/dev/mapper/sda2_crypt  235G  164G   69G  71% /
...
</code></pre><p>If you add 164G and 69G, you get 233G, which is 2G short of the actual size.
This is about 1%, but on your system it will likely be more of 5% difference.
The reason is the distinction between &ldquo;free&rdquo; and &ldquo;available&rdquo; space. Per default
on ext4, there are about 5% of &ldquo;reserved&rdquo; blocks. This has two reasons: First
ext4&rsquo;s performance seems to take a small hit, when almost full. Secondly, it
leaves a little space for root to login and troubleshoot problems or delete
some files, when users filled their home-directory. If there was <em>no</em> space
left, it might well be, that no login is possible anymore (because of the
creation of temporary files, logfiles, history-files…). So use <code>tune2fs &lt;path_to_your_disk></code> to see, if you have reserved blocks, and how many of them:</p><pre tabindex=0><code>mero@rincewind ~$ sudo tune2fs -l /dev/mapper/sda2_crypt | grep &#34;Reserved block&#34;
Reserved block count:     2499541
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
</code></pre><h2 id=do-you-have-too-many-files>Do you have too many files?<a hidden class=anchor aria-hidden=true href=#do-you-have-too-many-files>#</a></h2><p>Even though you might have enough space left, it might well be, that you have
too many files. ext4 allows an enormous amount of files on any file system, but
it is limited. Checking this is easy: Just use <code>df -i</code>:</p><pre tabindex=0><code>Filesystem               Inodes  IUsed    IFree IUse% Mounted on
/dev/mapper/sda2_crypt 15622144 925993 14696151    6% /
...
</code></pre><p>So as you see, that wasn&rsquo;t the problem with me. But if you ever have the <code>IUse%</code>
column near 100, you probably want to delete some old files (and you should
<em>definitely</em> question, how so many files could be created to begin with).</p><h2 id=do-a-file-system-check>Do a file system check<a hidden class=anchor aria-hidden=true href=#do-a-file-system-check>#</a></h2><p>At least some people on the internet say, that something like this has
happened to them after a crash (coincidentally my system crashed before the
problem arose. See above comments about offlineimap) and that a file system
check got rid of it. So you probably want to run <code>fsck -f &lt;path_to_your_disk></code>
to run such a check. You probably also want to do that from a live-system, if
you cannot unmount it (for example if it&rsquo;s mounted at the root-dir).</p><h2 id=do-you-have-dir_index-enabled>Do you have <code>dir_index</code> enabled?<a hidden class=anchor aria-hidden=true href=#do-you-have-dir_index-enabled>#</a></h2><p>So this is the punch line: ext4 has the possibility to hash the filenames of
its contents. This enhances performance, but has a “small” problem: ext4 does
not grow its hashtable, when it starts to fill up. Instead it returns -ENOSPC
or “no space left on device”.</p><p>ext4 uses <code>half_md4</code> as a default hashing-mechanism. If I interpret my
google-results correctly, this uses the md4-hash algorithm, but strips it to 32
bits. This is a classical example of the
<a href=http://en.wikipedia.org/wiki/Birthday_problem>birthday-paradox</a>: A 32 bit
hash means, that there are 4294967296 different hash values available, so if we
are fair and assume a uniform distribution of hash values, that makes it highly
unlikely to hit one specific hash. But the probability of hitting two identical
hashes, given enough filenames, is much much higher. Using the
<a href=http://en.wikipedia.org/wiki/Birthday_problem#Cast_as_a_collision_problem>formula</a>
from Wikipedia we get (with about 50K files) a probability of about 25% that a
newly added file has the same hash. This is a huge probability of failure. If
on the other hand we take a 64bit hash-function the probability becomes much
smaller, about 0.00000000007%.</p><p>So if you have a lot of files in the same directory, you probably want to switch
off <code>dir_index</code>, or at least change to a different hash-algorithm. You can
check if you have <code>dir_index</code> enabled and change the hash, like this:</p><pre tabindex=0><code>mero@rincewind ~$ sudo tune2fs -l /dev/mapper/sda2_crypt | grep -o dir_index
dir_index

## Change the hash-algo to a bigger one
mero@rincewind ~$ sudo tune2fs -E &#34;hash_alg=tea&#34; /dev/mapper/sda2_crypt
## Disable it completely
mero@rincewind ~$ sudo tune2fs -O &#34;^dir_index&#34;
</code></pre><p>Note however, that <code>dir_index</code> and <code>half_md4</code> where choices made for
performance reasons. So you might experience a performance-hit after this.</p><p><strong>UPDATE:</strong> After trying it out, I realized, that the problem actually also
persists with the tea-hash. I then had a look at <a href=https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Hash_Tree_Directories>the
ext4-documentation</a>
about the topic and it seems, that the hash is only stored as 32 bits, so it
actually does not matter what hash we choose, regarding this particular
problem. So if <code>half_md4</code> is chosen <a href="http://git.whamcloud.com/?p=tools/e2fsprogs.git;a=commitdiff_plain;h=d1070d91b4de8438dc78c034283baaa19b31d25e">because of its better performance and
collision-resistance</a>
it actually makes sense to leave it as the default. You can by the way easily
test and reproduce the issue by using the following on an ext4 file system:</p><pre tabindex=0><code>for a in `seq 100000`
do
        file=`head -c 51 /dev/urandom | base64 | tr &#39;/&#39; &#39;_&#39;`
        touch $file
done
</code></pre><p>Curiously, this only gives me about 160 collisions on 100K files (instead of
about 10K collisions on 60K files), which would suggest, that my original
sample (meaning my mailbox) exhibits some properties that make collisions more
likely both on <code>half_md4</code> <em>and</em> <code>tea</code>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.merovius.de/tags/linux/>linux</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.merovius.de/>Mero's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>