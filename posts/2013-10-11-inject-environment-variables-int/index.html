<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Inject Environment variables into running processes | Mero's Blog</title><meta name=keywords content="linux"><meta name=description content="Using gdb to manipulate a running process is fun and just the right amount of danger to be exiting"><meta name=author content><link rel=canonical href=https://blog.merovius.de/posts/2013-10-11-inject-environment-variables-int/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.merovius.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.merovius.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.merovius.de/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.merovius.de/apple-touch-icon.png><link rel=mask-icon href=https://blog.merovius.de/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Inject Environment variables into running processes"><meta property="og:description" content="Using gdb to manipulate a running process is fun and just the right amount of danger to be exiting"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.merovius.de/posts/2013-10-11-inject-environment-variables-int/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-10-11T03:25:09+00:00"><meta property="article:modified_time" content="2013-10-11T03:25:09+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Inject Environment variables into running processes"><meta name=twitter:description content="Using gdb to manipulate a running process is fun and just the right amount of danger to be exiting"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.merovius.de/posts/"},{"@type":"ListItem","position":2,"name":"Inject Environment variables into running processes","item":"https://blog.merovius.de/posts/2013-10-11-inject-environment-variables-int/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Inject Environment variables into running processes","name":"Inject Environment variables into running processes","description":"Using gdb to manipulate a running process is fun and just the right amount of danger to be exiting","keywords":["linux"],"articleBody":"tl;dr: Using gdb to manipulate a running process is fun and just the right amount of danger to be exiting\nJust to document this (a friend asked me): If you ever wanted for example to globally change your $PATH, or add a global $LD_PRELOAD (for example to use insulterr ;) ), without restarting your session, gdb is your friend.\nYou can call arbitrary functions in the context of any process (that you are priviledged to attach a debugger, it has to run under your uid or you have to be root, see ptrace(2) for specifics), as long as they are linked. Almost everything is linked to libld, so with enough effort this actually means every function.\nFor example, suppose you are running i3wm and want to add /home/user/insulterr/insulterr.so to your $LD_PRELOAD in every process started by i3:\n$ gdb -p `pidof i3` `which i3` gdb $ call setenv(\"LD_PRELOAD\", \"/home/user/insulterr/insulterr.so\") gdb $ quit A debugging session is active. Inferior 1 [process 2] will be detached. Quit anyway? (y or n) y Detaching from program: /usr/bin/i3, process 2 This is of course a terrible hack, by high standards. Things to look out for are (off the top of my head):\n You call a function that manipulates errno or does some other non-reentrent things. If you are attaching the debugger right in the middle of a library call (or immediately after) this might make the program unhappy because it does not detect an error (or falsely thinks there is an error). You call a function that does not work in a multithreaded context and another thread modifies it at the same time. Bad. You interrupt a badly checked read(2)/write(2)/whatever(…) call and a badly written program doesn’t realize it got less data then expected (and/or crashes). Shouldn’t happen in practice, if it does, file a bug. You try to use symbols that are not available. This is actually not very bad and can be worked around (a friend of mine had the problem of needing false and just substituted 0). You use a daemon (like urxvtd(1)) for your terminals and the environment does not get passed correctly. This is also not very bad, just confusing. Attach your debugger to the daemon and change the environment there too. You attach the debugger to some process vital to the interaction with your debugger. Your window manager is a mild example. The terminal daemon is slightly worse (because, well, you can’t actually type in the terminal window that your debugger is running in, ergo you can’t stop it…), but you can change to a virtual terminal. Something like getty or init might be killing it.  Have fun!\n","wordCount":"445","inLanguage":"en","datePublished":"2013-10-11T03:25:09Z","dateModified":"2013-10-11T03:25:09Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.merovius.de/posts/2013-10-11-inject-environment-variables-int/"},"publisher":{"@type":"Organization","name":"Mero's Blog","logo":{"@type":"ImageObject","url":"https://blog.merovius.de/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.merovius.de/ accesskey=h title="Mero's Blog (Alt + H)">Mero's Blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Inject Environment variables into running processes</h1><div class=post-meta><span title="2013-10-11 03:25:09 +0000 UTC">October 11, 2013</span></div></header><div class=post-content><p><strong>tl;dr: Using gdb to manipulate a running process is fun and just the right
amount of danger to be exiting</strong></p><p>Just to document this (a friend asked me): If you ever wanted for example to
globally change your <code>$PATH</code>, or add a global <code>$LD_PRELOAD</code> (for example to use
<a href=https://github.com/Merovius/insulterr>insulterr</a> ;) ), without restarting
your session, gdb is your friend.</p><p>You can call arbitrary functions in the context of any process (that you are
priviledged to attach a debugger, it has to run under your uid or you have to
be root, see <code>ptrace(2)</code> for specifics), as long as they are linked. Almost
everything is linked to <code>libld</code>, so with enough effort this actually means
<em>every</em> function.</p><p>For example, suppose you are running <a href=http://i3wm.org>i3wm</a> and want to add
<code>/home/user/insulterr/insulterr.so</code> to your <code>$LD_PRELOAD</code> in every process
started by i3:</p><pre tabindex=0><code>$ gdb -p `pidof i3` `which i3`
&lt;lots of output of gdb&gt;
gdb $ call setenv(&#34;LD_PRELOAD&#34;, &#34;/home/user/insulterr/insulterr.so&#34;)
gdb $ quit
A debugging session is active.

	Inferior 1 [process 2] will be detached.

Quit anyway? (y or n) y
Detaching from program: /usr/bin/i3, process 2
</code></pre><p>This is of course a terrible hack, by high standards. Things to look out for
are (off the top of my head):</p><ul><li>You call a function that manipulates <code>errno</code> or does some other non-reentrent
things. If you are attaching the debugger right in the middle of a library
call (or immediately after) this <em>might</em> make the program unhappy because it
does not detect an error (or falsely thinks there is an error).</li><li>You call a function that does not work in a multithreaded context and another
thread modifies it at the same time. Bad.</li><li>You interrupt a badly checked <code>read(2)</code>/<code>write(2)</code>/<code>whatever(…)</code> call and a
badly written program doesn&rsquo;t realize it got less data then expected (and/or
crashes). Shouldn&rsquo;t happen in practice, if it does, file a bug.</li><li>You try to use symbols that are not available. This is actually not very bad
and can be worked around (a friend of mine had the problem of needing <code>false</code>
and just substituted 0).</li><li>You use a daemon (like <code>urxvtd(1)</code>) for your terminals and the environment
does not get passed correctly. This is also not very bad, just confusing.
Attach your debugger to the daemon and change the environment there too.</li><li>You attach the debugger to some process vital to the interaction with your
debugger. Your window manager is a mild example. The terminal daemon is
slightly worse (because, well, you can&rsquo;t actually type in the terminal window
that your debugger is running in, ergo you can&rsquo;t stop it…), but you can
change to a virtual terminal. Something like getty or init might be killing
it.</li></ul><p>Have fun!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.merovius.de/tags/linux/>linux</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.merovius.de/>Mero's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>